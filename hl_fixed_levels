#!/usr/bin/env python3
import sys
import os
import json
from datetime import datetime
import subprocess

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
CONFIG_DIR = os.path.expanduser("~/.hacklab")
CONFIG_FILE = os.path.join(CONFIG_DIR, "config.json")
PROGRESS_FILE = os.path.join(CONFIG_DIR, "progress.json")

def load_config():
    if not os.path.exists(CONFIG_FILE):
        return {"mode": "beginner", "level": 1, "xp": 0}
    with open(CONFIG_FILE, "r") as f:
        return json.load(f)

def save_config(data):
    os.makedirs(CONFIG_DIR, exist_ok=True)
    with open(CONFIG_FILE, "w") as f:
        json.dump(data, f, indent=2)

def check_level_up(config):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –ø–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ"""
    if config.get("mode") != "beginner":
        return config
    
    xp_needed = [0, 100, 250, 500, 850, 1300, 1850, 2500, 3250, 4100]
    level = config.get("level", 1)
    xp = config.get("xp", 0)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —É—Ä–æ–≤–Ω–∏
    while level < 10 and xp >= xp_needed[level]:
        level += 1
        print(f"üéâ –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù: {level-1} ‚Üí {level}!")
        
        level_names = {
            1: "ü•ö Egg", 2: "üê£ Chick", 3: "üê• Chicken",
            4: "ü¶Ö Eagle", 5: "ü¶â Owl", 6: "üê∫ Wolf",
            7: "üêâ Dragon", 8: "üßô Wizard", 9: "üëë King",
            10: "üèÜ Legend"
        }
        
        if level in level_names:
            print(f"üèÜ –ù–æ–≤—ã–π —Ç–∏—Ç—É–ª: {level_names[level]}")
        
        # –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        tools = {
            1: ["üåê network_info", "üì° port_check"],
            2: ["üîç web_scanner"],
            3: ["üîê ssl_checker"],
            4: ["üåç whois_checker"],
            5: ["üìÅ dir_buster"],
            6: ["üîé subdomain_scanner"],
            7: ["‚ö†Ô∏è  cve_lookup"],
            8: ["üîë hash_cracker"],
            9: ["üíâ sql_tester"],
            10: ["üéØ xss_scanner", "ü§ñ api_fuzzer"]
        }
        
        if level in tools:
            print(f"üéÅ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:")
            for tool in tools[level]:
                print(f"   ‚Ä¢ {tool}")
        
        if level == 10:
            print(f"\nüöÄ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –£–†–û–í–ù–Ø 10!")
            print(f"üíº –í—ã –≥–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º!")
            print(f"üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: hl mode professional")
        
        print("="*50)
    
    config["level"] = level
    return config

def first_run():
    print("="*50)
    print("üöÄ HACKLAB MANAGER v2.0")
    print("="*50)
    print()
    print("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å:")
    print()
    print("[1] üéì –ù–û–í–ò–ß–û–ö")
    print("    ‚Ä¢ –ù–∞—á–Ω—É —Å –æ—Å–Ω–æ–≤ –ø–µ–Ω—Ç–µ—Å—Ç–∞")
    print("    ‚Ä¢ –ü–æ—à–∞–≥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ")
    print("    ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É—á–µ–±–Ω—ã–µ —Ü–µ–ª–∏")
    print()
    print("[2] üî• –û–ü–´–¢–ù–´–ô –ü–ï–ù–¢–ï–°–¢–ï–†")
    print("    ‚Ä¢ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ")
    print("    ‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å—Ä–∞–∑—É")
    print("    ‚Ä¢ –î–ª—è —Ç–µ—Ö —É –∫–æ–≥–æ –µ—Å—Ç—å –æ–ø—ã—Ç")
    print()
    
    while True:
        choice = input("–í–∞—à –≤—ã–±–æ—Ä (1 –∏–ª–∏ 2): ").strip()
        if choice == "1":
            config = {
                "mode": "beginner",
                "level": 1,
                "xp": 0,
                "first_run": False,
                "created": datetime.now().isoformat()
            }
            save_config(config)
            print("‚úÖ –†–µ–∂–∏–º '–ù–æ–≤–∏—á–æ–∫' –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!")
            break
        elif choice == "2":
            config = {
                "mode": "professional",
                "level": 10,
                "xp": 5000,
                "first_run": False,
                "created": datetime.now().isoformat()
            }
            save_config(config)
            print("üî• –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!")
            print("–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã!")
            break
        else:
            print("‚ùå –í–≤–µ–¥–∏—Ç–µ 1 –∏–ª–∏ 2")

def show_help():
    config = load_config()
    mode = config.get("mode", "beginner")
    
    print("="*50)
    print(f"HACKLAB MANAGER - –†–µ–∂–∏–º: {mode.upper()}")
    print("="*50)
    print()
    print("üìã –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:")
    print("  hl scan <target>    - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–∏")
    print("  hl dashboard        - –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å")
    print("  hl mode [beg/pro]   - –°–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º")
    print("  hl tools            - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã")
    print("  hl level            - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Ä–æ–≤–Ω–µ")
    print("  hl premium          - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Premium")
    print("  hl help             - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞")
    print()
    
    if mode == "beginner":
        print("üéì –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ù–û–í–ò–ß–ö–û–í:")
        print("  hl learn           - –û–±—É—á–µ–Ω–∏–µ")
        print("  hl practice        - –£—á–µ–±–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è")
    else:
        print("üî• –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´:")
        print("  hl scan --full     - –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ")
        print("  hl report          - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤")
    print("="*50)

def cmd_scan(target):
    config = load_config()
    mode = config.get("mode", "beginner")
    
    safe_targets = ["scanme.nmap.org", "example.com", "8.8.8.8", "1.1.1.1"]
    
    if mode == "beginner" and target not in safe_targets:
        print("‚ùå –í —Ä–µ–∂–∏–º–µ –ù–æ–≤–∏—á–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ü–µ–ª–∏:")
        for t in safe_targets:
            print(f"   ‚Ä¢ {t}")
        print()
        print("üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: hl mode professional")
        return
    
    print(f"üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {target}...")
    
    import subprocess
    result = subprocess.run(["nmap", "-p", "80,443,22", target], 
                          capture_output=True, text=True)
    
    scan_dir = os.path.join(os.path.expanduser("~"), ".hacklab", "scans")
    os.makedirs(scan_dir, exist_ok=True)
    
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    scan_file = os.path.join(scan_dir, f"{target}_{timestamp}.txt")
    
    with open(scan_file, "w") as f:
        f.write(f"–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {target}\n")
        f.write(f"–î–∞—Ç–∞: {datetime.now()}\n")
        f.write(f"–†–µ–∂–∏–º: {mode}\n")
        f.write("-"*50 + "\n")
        f.write(result.stdout)
    
    print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: {scan_file}")
    
    if mode == "beginner":
        old_level = config.get("level", 1)
        config["xp"] = config.get("xp", 0) + 25
        config = check_level_up(config)
        save_config(config)
        
        print(f"üéâ +25 XP –ø–æ–ª—É—á–µ–Ω–æ!")
        
        if config.get("level", 1) > old_level:
            print(f"üèÜ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!")

def cmd_dashboard():
    config = load_config()
    mode = config.get("mode", "beginner")
    level = config.get("level", 1)
    xp = config.get("xp", 0)
    
    print("="*50)
    print("üìä –í–ê–® –ü–†–û–ì–†–ï–°–°")
    print("="*50)
    print(f"üë§ –†–µ–∂–∏–º: {mode}")
    print(f"üéÆ –£—Ä–æ–≤–µ–Ω—å: {level}")
    print(f"‚≠ê XP: {xp}")
    
    if mode == "beginner":
        xp_needed = [0, 100, 250, 500, 850, 1300, 1850, 2500, 3250, 4100]
        if level < 10:
            current = xp - xp_needed[level-1]
            needed = xp_needed[level] - xp_needed[level-1]
            progress = (current / needed) * 100 if needed > 0 else 100
            print(f"üìà –î–æ —É—Ä–æ–≤–Ω—è {level+1}: {current}/{needed} XP ({progress:.1f}%)")
        
        if level >= 10:
            print()
            print("üöÄ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 10 —É—Ä–æ–≤–Ω—è!")
            print("–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –≤ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º:")
            print("üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: hl mode professional")
    
    print("="*50)

def cmd_mode(new_mode):
    config = load_config()
    current_mode = config.get("mode", "beginner")
    
    if new_mode not in ["beginner", "professional"]:
        print("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: hl mode beginner –∏–ª–∏ hl mode professional")
        return
    
    if current_mode == new_mode:
        print(f"‚ÑπÔ∏è  –í—ã —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ {new_mode}")
        return
    
    if current_mode == "beginner" and new_mode == "professional":
        level = config.get("level", 1)
        if level < 10:
            print("‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è 10 —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º")
            print(f"   –í–∞—à —É—Ä–æ–≤–µ–Ω—å: {level}")
            return
        
        print("="*50)
        print("üöÄ –ü–ï–†–ï–•–û–î –í –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú")
        print("="*50)
        print("–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 10 —É—Ä–æ–≤–Ω—è –∏ –≥–æ—Ç–æ–≤—ã –∫ –ü—Ä–æ-—Ä–µ–∂–∏–º—É!")
        print()
        print("‚ö†Ô∏è  –í –ü—Ä–æ-—Ä–µ–∂–∏–º–µ:")
        print("   ‚Ä¢ –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ü–µ–ª—è–º")
        print("   ‚Ä¢ –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫")
        print("   ‚Ä¢ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—Å")
        print()
        confirm = input("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ (yes/no): ").strip().lower()
        
        if confirm not in ["yes", "y", "–¥–∞", "–¥"]:
            print("‚ùå –ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω")
            return
    
    config["mode"] = new_mode
    save_config(config)
    print(f"‚úÖ –†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω: {current_mode} ‚Üí {new_mode}")

def cmd_tools():
    config = load_config()
    mode = config.get("mode", "beginner")
    level = config.get("level", 1)
    
    tools = {
        1: ["üåê network_info", "üì° port_check"],
        2: ["üîç web_scanner"],
        3: ["üîê ssl_checker"],
        4: ["üåç whois_checker"],
        5: ["üìÅ dir_buster"],
        6: ["üîé subdomain_scanner"],
        7: ["‚ö†Ô∏è  cve_lookup"],
        8: ["üîë hash_cracker"],
        9: ["üíâ sql_tester"],
        10: ["üéØ xss_scanner", "ü§ñ api_fuzzer"]
    }
    
    print("="*50)
    print("üõ†Ô∏è  –í–ê–®–ò –ò–ù–°–¢–†–£–ú–ï–ù–¢–´")
    print("="*50)
    
    if mode == "professional":
        print("üî• –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú")
        print("–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã!")
        for lvl in range(1, 11):
            for tool in tools.get(lvl, []):
                print(f"  ‚úÖ {tool}")
    else:
        print(f"üéì –ù–û–í–ò–ß–û–ö (–£—Ä–æ–≤–µ–Ω—å {level})")
        unlocked = []
        for lvl in range(1, level + 1):
            for tool in tools.get(lvl, []):
                unlocked.append(tool)
                print(f"  ‚úÖ {tool}")
        
        if level < 10:
            print()
            print("üîí –ë–£–î–£–¢ –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–´:")
            for lvl in range(level + 1, 11):
                for tool in tools.get(lvl, []):
                    print(f"  üîí {tool} (–£—Ä–æ–≤–µ–Ω—å {lvl})")
    
    print("="*50)

def cmd_learn():
    learn_script = os.path.join(os.path.expanduser("~"), "hacklab_v2", "learn.py")
    if os.path.exists(learn_script):
        subprocess.run(["python3", learn_script])
    else:
        print("‚ùå –§–∞–π–ª –æ–±—É—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω")
        print(f"–û–∂–∏–¥–∞–ª—Å—è: {learn_script}")

def main():
    if not os.path.exists(CONFIG_FILE):
        first_run()
        show_help()
        return
    
    if len(sys.argv) < 2:
        show_help()
        return
    
    command = sys.argv[1]
    
    if command == "scan":
        if len(sys.argv) < 3:
            print("‚ùå –£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
            print("–ü—Ä–∏–º–µ—Ä: hl scan scanme.nmap.org")
            return
        cmd_scan(sys.argv[2])
    
    elif command == "dashboard":
        cmd_dashboard()
    
    elif command == "mode":
        if len(sys.argv) < 3:
            print("‚ùå –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∂–∏–º: beginner –∏–ª–∏ professional")
            return
        cmd_mode(sys.argv[2])
    
    elif command == "tools":
        cmd_tools()
    
    elif command == "level":
        config = load_config()
        level = config.get("level", 1)
        xp = config.get("xp", 0)
        print(f"üéÆ –í–∞—à —É—Ä–æ–≤–µ–Ω—å: {level}")
        print(f"‚≠ê XP: {xp}")
        
        if config.get("mode") == "beginner" and level < 10:
            xp_needed = [0, 100, 250, 500, 850, 1300, 1850, 2500, 3250, 4100]
            needed = xp_needed[level] - xp
            print(f"üìà –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –Ω—É–∂–Ω–æ: {needed} XP")
    
    elif command == "premium":
        print("="*50)
        print("üí∞ HACKLAB MANAGER PREMIUM")
        print("="*50)
        print("–î–æ—Å—Ç—É–ø–Ω–æ –∑–∞ $15/–º–µ—Å—è—Ü –∏–ª–∏ $150/–≥–æ–¥")
        print()
        print("üî• PREMIUM –§–ò–ß–ò:")
        print("  ‚Ä¢ HTB API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è")
        print("  ‚Ä¢ Shodan –ø–æ–∏—Å–∫")
        print("  ‚Ä¢ PDF –æ—Ç—á–µ—Ç—ã")
        print("  ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á")
        print("  ‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞")
        print()
        print("üí° –î–ª—è –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ:")
        print("   https://hacklab-manager.com/premium")
        print("="*50)
    
    elif command == "learn":
        cmd_learn()
    
    elif command == "help":
        show_help()
    
    else:
        print(f"‚ùå –ö–æ–º–∞–Ω–¥–∞ '{command}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        show_help()

if __name__ == "__main__":
    main()
